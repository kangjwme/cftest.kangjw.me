<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>一起來看看酷酷 Cloudflare 分配</title>
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css'><link rel="stylesheet" href="./style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<!-- partial:index.partial.html -->
<main >
  <div id="pieChart"></div>
    <div class="container p-5">
            <table class="table align-middle mb-0 bg-white">
                <thead class="bg-white" id="praject-table">
                    <tr>
                        <th class="text-center" style="width:65px;">等級</th>
                        <th class="text-center">網址</th>
                        <th class="text-center">來源</th>
                        <th class="text-center">延遲</th>
                    </tr>
                </thead>
                <tbody id="result">
                    
                </tbody>
            </table>
        </div>
    </div>
</main>
<!-- partial -->
<script>
    const urls = [
  { url: "cheapserver.tw", type: "Free" },
  { url: "kangjw.me", type: "Free" },
  { url: "thisisch.net", type: "Free" },
      { url: "zhuyuannice.link", type: "Free" },
  { url: "cdnjs.com", type: "Pro" },
  { url: "webpack.js.org", type: "Pro" },
  { url: "nodejs.org", type: "Pro" },
  { url: "nafstore.net", type: "Business" },
  { url: "thetrevorproject.org", type: "Business" },
  { url: "voteamerica.com", type: "Business" },
  { url: "polestar.com", type: "Enterprise" },
  { url: "www.ncr.com", type: "Enterprise" },
];

const typeCount = {};


async function getColo(url) {
  
  try {
    const start = performance.now();
    const response = await fetch("https://" + url + "/cdn-cgi/trace");
    const text = await response.text();

    const regex = /colo=([\w]+)/;
    const match = text.match(regex);
    const end = performance.now();
    const duration = end - start;

    return [match[1],Math.round(duration) + ' ms' ];
  } catch (error) {
    return "無法偵測";
  }
  
}

(async () => {
  const airportData = await fetch('cf.json').then(res => res.json());

  for (let data of urls) {
    const colo = await getColo(data['url']);
    const city = airportData[colo[0]] || '';

    if (!typeCount[data['type']]) {
      typeCount[data['type']] = 1;
    } else {
      typeCount[data['type']]++;
    }

    let row = `
      <tr>
        <td class="text-center">${data['type']}</td>
        <td class="text-center">${data['url']}</td>
        <td class="text-center"><strong>${colo[0]}</strong> (${city})</td>
        <td class="text-center">${colo[1]}</td>
      </tr>
    `;

    document.querySelector("#result").innerHTML += row;
  }

  
  
})();



  </script>
  
</body>
</html>
